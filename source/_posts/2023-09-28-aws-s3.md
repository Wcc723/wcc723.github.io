---
layout: post
title: AWS S3 申請設定以及 Node.js 串接方式
category: development
tagline:
tags: [javascript, nodejs]
cssdemo: 
jsdemo:
thumbnail:
photo: https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2FAWS-S3-cover.jpg?alt=media&token=478ccefa-a57f-4756-b4f3-6c5e64d31d8f
published: true
---


{% raw %} 
<div class="ratio ratio-16x9">
<iframe width="100%" src="https://www.youtube.com/embed/y12KO8XM6jw" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
</div>
{% endraw %}
這是鐵人賽相關文章，影片會在活動開始後發布

AWS S3 是雲端靜態檔案的儲存服務，簡單來說就是能夠把圖片、影片等上傳後不太會更動的檔案進行上傳，接下來用戶在觀看時，就能夠直接存取這些檔案。

而這個服務僅會作為靜態檔案儲存使用，因此在價格上會相對直接將檔案存到虛擬主機來得低上許多，本篇會介紹申請以及完整上傳的流程，在開始之前也請先確保已經有 AWS 帳號，並且已經綁定信用卡。

### 流程說明

1. 建立 IAM 帳號： 首先會先建立 IAM 帳號，為了安全性，我們會透過一個子帳號來進行上傳，所以必須先賦予子帳號 S3 相關權限。
2. 建立 S3 Bucket：接下來就能開始準備上傳流程，也會說明相關的權限設置。
3. 撰寫程式碼～

## 建立 IAM 帳號
可以在 AWS 導覽列中輸入 IAM，接下來就會在彈出視窗中找到 IAM 管理工具。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_10_52.png?alt=media&token=c432e033-9821-4159-bc55-83344e139bdf)

接下來建立一個新的使用者，我們會賦予他 S3 的管理權限。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_10_53.png?alt=media&token=5105397d-8592-4fa2-8a68-d1ae4b01c4f8)

顧名思義，你可以定義使用者的名稱，在此不需要給予額外的管理控制台權限。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F884D3207-26DC-4377-8D78-060E112FFE67.png?alt=media&token=786a66de-7128-4641-bb90-b39e6945bc6d)

在設定許可中，選擇「直接連接政策」，搜尋欄中可以輸入「S3」，許可政策選擇「AmazonS3FullAccess」，接下來按下下一步、建立使用者即可。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_10_55.png?alt=media&token=7893bb72-dab0-4d25-bbfe-acf69608f0ff)

在這個流程中已經建立了一個使用者，接下來會需要取得這使用者的存取方式，用來作為 Node.js 存取的方法。

回到 IAM 使用者列表，點選剛剛所建立的使用者，在畫面的上方可以找到建立存取金鑰。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_10_58.png?alt=media&token=e7584bc0-0b09-490e-8d80-57e9bf64b62b)

他會問你做什麼用的，據說選什麼沒太大關係，但我們還是乖乖選擇本機代碼。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_10_59.png?alt=media&token=30b10b06-26a0-46f9-b4e5-9fbdc9d105bc)

最後，把這個金鑰存起來，記得這個畫面只能進來一次，請準備好有地方存再開啟。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_11_00.png?alt=media&token=509953bd-dac2-4d25-8d01-a6517e3289c5)

## 建立 S3 Bucket

Bucket 策略有兩種，本篇會直接調整 Bucket 的公開政策，讓在此 Bucket 的圖片均可以直接存取，為什麼這麼做可以參考 [AWS 所提供的文件](https://aws.amazon.com/tw/blogs/security/iam-policies-and-bucket-policies-and-acls-oh-my-controlling-access-to-s3-resources/)。

回到 S3 的服務中，選擇建立儲存貯體（Bucket）。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_11_02.png?alt=media&token=8b1b2a50-5f9f-48be-b726-11059b7b51a5)

接下來就按照需求輸入名稱以及選擇區域，區域會影響：
- 存取速度
- 價格
而其中的價格影響較小，會建議依據服務受眾所在地區進行選擇。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_11_03.png?alt=media&token=599ca8ab-a296-441a-98ea-cbd772354728)

接下來回到建立的 Bucket，選擇「許可」，在此會開放此 Bucket 的公開權限。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_11_04.png?alt=media&token=907121ee-60ac-4181-9222-341e5db92b4e)

按照下圖的設定方式並儲存。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F044FED66-048A-4C36-AA46-9A9845F1B10E.png?alt=media&token=3f17e406-b7bb-4f1d-a3ff-a61b785e5156)

接下來政策也需要調整，按下編輯。
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_9_17_11_05.png?alt=media&token=916aa9ad-7d0b-47f9-96ce-c7e75ffb58a3)

依據下圖輸入（下方有附上程式碼），確認後進行儲存
![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F4FD690EB-8FFF-4FE3-A059-0EBAD6D4723A.png?alt=media&token=87b6632f-d94b-4c47-af57-d5266490ee93)

Bucket 政策原始碼。
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::{{ bucket name }}/*"
        }
    ]
}
```


## 回到程式碼

在此有提供完整的 Node.js 程式碼，依據需求將 IAM 及 Bucket 申請的資料填入 `.env` 即可（請參照 `.env.sample` ）。

完整範例：https://github.com/Wcc723/node-ironman-sample-2023/tree/feature/aws-s3-upload

如果在開發上有問題，建議參考本影片，會帶你從頭開始申請並上傳圖片喔：https://youtu.be/y12KO8XM6jw