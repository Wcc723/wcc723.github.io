---
layout: post
title: 在伺服器上建置 Traefik Proxy 反向代理伺服器
category: development
tagline:
tags: [javascript, nodejs, traefik]
cssdemo: 
jsdemo:
thumbnail:
photo: https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2FTraefik.jpg?alt=media&token=c25324eb-decf-4b95-9677-b1a3b1df5464
published: true
---

{% raw %} 
<div class="ratio ratio-16x9">
<iframe width="100%" src="https://www.youtube.com/embed/CV3pi8KQEy0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
</div>
{% endraw %}
這是鐵人賽相關文章，影片會在活動開始後發布

本篇文章會介紹如何「如何在 Ubuntu 環境上加入 Traefik 工具，並且搭配 Cloudflare 進行多應用配置」，建議對於 Docker、Ubuntu 指令有基本的經驗，以下是本文包含的流程：
1. 在 Ubuntu 上安裝 Traefik，並使用 Cloudflare 對應 Traefik Dashboard
3. 配置 Node.js 專案

本文（影片）提及以及用到的工具、服務包含：
- [Traefik Proxy](https://doc.traefik.io/traefik/)
- [Cloudflare](https://www.cloudflare.com/)
- [範例專案](https://github.com/Wcc723/node-ironman-sample-2023/tree/feature/action-docker-traefik)

## 在 Ubuntu 上安裝 Traefik

Traefik 也是使用 Docker 容器運行，所以有 Docker 環境以後，我們可以先配置 Traefik 的設定檔：

```bash
mkdir traefik
cd traefik
vi traefik.yml
# 建立資料夾、準備設定 `traefik.yml` 檔案
```

在此提供兩個版本的設定檔，一個是搭配一般的 Name Server，另一種則是搭配 Cloudflare，使用 Cloudflare 的優點在於可以使用 Cloudflare 的 SSL 憑證，配置上更簡單、免費。

![Cloudflare 上的配置說明](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E6%88%AA%E5%9C%96%202023-10-08%2010.37.18.png?alt=media&token=880cad73-982b-480a-aa3d-552ea02e7a89)

#### 一般 Name Server：

這是通用的設定檔案，不過這種並沒有 SSL 憑證，在瀏覽器上會顯示 “不安全” 的提示，所以這段建議只用在練習上。

```yml
log:
  level: DEBUG

api:
  dashboard: true
  insecure: true

entryPoints:
  web:
    address: ":80"

providers:
  docker:
    exposedByDefault: false
```

#### 搭配 Cloudflare

Cloudflare 憑證設定又可分為 flex 以及完整兩個版本。flex 是使用 Cloudflare 的 SSL 憑證，但是不會驗證，所以在瀏覽器上會顯示 “安全” 的提示，但是實際上並沒有驗證，所以這段建議只用在練習上。

以下範例是以 flex 憑證為例，但在註解中有說明如果是 “完整” 的版本加入後該如何設定。

```yml
log:
  level: DEBUG

api:
  dashboard: true
  insecure: true

entryPoints:
  web:
    address: ":80"
    forwardedHeaders:
      trustedIPs: #cloudflare ips
        - "173.245.48.0/20"
        - "173.245.48.0/20"
        - "103.21.244.0/22"
        - "103.22.200.0/22"
        - "103.31.4.0/22"
        - "141.101.64.0/18"
        - "108.162.192.0/18"
        - "190.93.240.0/20"
        - "188.114.96.0/20"
        - "197.234.240.0/22"
        - "198.41.128.0/17"
        - "162.158.0.0/15"
        - "104.16.0.0/13"
        - "104.24.0.0/14"
        - "172.64.0.0/13"
        - "131.0.72.0/22"
    # http:
    #   redirections: # 重新導向
    #     entrypoint:
    #       to: websecure
    #       scheme: https
    #       permanent: true

  # websecure: 
  #   address: :443
    # forwardedHeaders:
    #   trustedIPs: #cloudflare ips
    #     - "173.245.48.0/20"
    #     - "173.245.48.0/20"
    #     - "103.21.244.0/22"
    #     - "103.22.200.0/22"
    #     - "103.31.4.0/22"
    #     - "141.101.64.0/18"
    #     - "108.162.192.0/18"
    #     - "190.93.240.0/20"
    #     - "188.114.96.0/20"
    #     - "197.234.240.0/22"
    #     - "198.41.128.0/17"
    #     - "162.158.0.0/15"
    #     - "104.16.0.0/13"
    #     - "104.24.0.0/14"
    #     - "172.64.0.0/13"
    #     - "131.0.72.0/22"

providers:
  docker:
    exposedByDefault: false

# tls:
#   certificates:
#     - certFile: /root/traefik/cert.pem
#       keyFile: /root/traefik/tls.key

# ====
# 如果有憑證，可以在此設置，設置 Let's Encrypt 作為 HTTPS 的證書提供者
# certificatesResolvers:
#   letsencrypt:
#     acme:
#       email: youremail@example.com
#       storage: acme.json
#       httpChallenge:
#         # 用於 HTTP 證書的入口點
#         entryPoint: web
```

接下來在環境中建立一個 docker compose，與 treafik 的對應都會透過 Docker Compose 的設定，而不是寫在 Traefik 的檔案中。
    
```bash
vi docker-compose.yml
```

以下是 Traefik 的 docker-compose.yml 設定檔案，這邊有幾個重點：
- 使用 `networks` 設定網路，這邊使用 `casper` 作為網路名稱
- 使用 `volumes` 設定掛載檔案，這邊使用 `./traefik.yml:/root/traefik/traefik.yml` 將本地端的 `traefik.yml` 檔案掛載到容器中的 `/root/traefik/traefik.yml` 路徑
- 使用 `labels` 設定 Traefik 的設定，這邊使用 `traefik.enable=true` 啟用 Traefik，其後續的配置一樣須依據環境依序調整
- Host 部分請自行設定對應的主機名（使用 Record "A" 設定 ip 即可）

```yml
version: '3.8'

services:
  traefik:
    image: traefik:v2.10
    command:
      - "--configFile=/root/traefik/traefik.yml"
    ports:
      - "80:80"
    volumes:
      - ./traefik.yml:/root/traefik/traefik.yml
      - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - traefik.enable=true
      - "traefik.http.routers.traefik.entrypoints=web" # 使用 web 入口點，對應到 80 端口
      - "traefik.http.routers.traefik.rule=Host(`custom.xxx`)" # 對應到 custom.xxx 主機名，請自行設定對應的主機名（使用 Record "A" 設定 ip 即可）
      - "traefik.http.routers.traefik.service=api@internal" # 設置服務為 Traefik 的內部 API
      - traefik.http.services.traefik.loadbalancer.server.port=8080
    # Network 可以在後面再加入
    networks:
      - casper

networks:
  casper:
    name: casper-network
```

Cloudflare 設定可參考下圖：

![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E6%88%AA%E5%9C%96%202023-10-08%2010.37.35.png?alt=media&token=44d63687-b37b-40e6-80d2-64c7ca5e370c)

接下來就可以啟動 Traefik 了。

```bash
docker-compose up -d
```

接下來在瀏覽器中輸入 `custom.xxx` 就可以看到 Traefik 的 Dashboard。

![Traefik Dashboard](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E6%88%AA%E5%9C%96%202023-10-08%2010.35.32.png?alt=media&token=6a025afc-0179-49c9-a379-c57d17322abe)

## 配置 Node.js 專案

接下來，Node.js 專案也會使用 docker-compose 進行建置，以下是 docker-compose.yml 的設定檔案，這邊有幾個重點：
- 一樣使用 `networks` 設定網路，這邊使用 `casper` 作為網路名稱
- 其餘配置可參考 Traefik 中的 docker-compose 設定，而這邊使用 `webservice` 作為服務名稱
- Host 部分請自行設定對應的主機名（使用 Record "A" 設定 ip 即可）

```yml
version: '3.8'
services:
  webservice: # 服務名稱
    #...其他設定
    networks: # 此網路設定需要與 traefik 一致
      - casper
    labels:
      - traefik.enable=true
      - "traefik.http.routers.webservice.entrypoints=web" # 使用 web 入口點，對應到 80 端口
      - "traefik.http.routers.webservice.rule=Host(`custom2.xxx`)" # 對應到 custom2.xxx 主機名
      - "traefik.http.routers.webservice.service=webservice" # 設置服務名稱
      - traefik.http.services.webservice.loadbalancer.server.port=3000

networks: # 最後，也再加入網路設定，所有需要使用相同 traefik 群組的，都要加入
  casper:
    name: casper-network
```

![](https://firebasestorage.googleapis.com/v0/b/casper-de5d5.appspot.com/o/images%2Fblog%2F%E8%B2%BC%E4%B8%8A%E7%9A%84%E5%BD%B1%E5%83%8F_2023_10_8_10_42.png?alt=media&token=d86c7a3a-7e58-4194-9da9-7404c5e113dd)

重新部署後，就可以在瀏覽器中輸入 `custom2.xxx` 就可以看到 Node.js 專案了，這樣就實現在同一台主機上，使用 Traefik 進行多應用配置了。